---
title: "Extortion in Mexico: Who pays and why?"
author: "Patricio R. Estevez Soto"
email: "patricio.estevez.14@ucl.ac.uk"
date: "30/9/2016"
output:
  md_document:
    variant: "markdown"
pandoc_args: "--smart"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      comment="",
                      cache=TRUE,
                      dev=c("png", "CairoPDF"),
                      error=TRUE)
```

# Introduction

This document contains the script and results for a research project on extortion against businesses in Mexico.

Previous research has found that extortion against businesses is acutely concentrated on a few businesses who experience more than half of all extortion incidents in the country as repeat extortion victimizations. That project found that the rate at which businesses suffer extortion is mostly determined by their characteristics---such as their age, whether they are a restaurant, the number of corruption incidents they have suffered, and their size---and to a lesser extent, to the characteristics of the state where they are located---which include the state homicide rate and other unmeasured between-state differences.

Nonetheless, that research did not consider that most extortion victims do not comply with extortion demands. Thus this project aims to explore the distribution of successful extortion incidents, and identify the incident, victim and area characteristics associated with a higher likelihood of complying with extortion.

The incident-level characteristics that will be explored are:

- month
- time of day
- number of offenders
- victim's relationship to the offender
- use of a weapon
- type of weapon
- use of violence
- whether the incident was reported to the authorities (MP + other)
- type of extortion
- what was requested
- retaliation against business for not complying
- whether the victim complied with the extortion

The victim-level characteristics are:
- business type
- business age
- business size
- Victim of corruption
- number of corruption victimizations, repeat corruption victim
- number of extortion victimizations
- repeat extortion victim

Area-level characteristics:
- State
- State homicides
- State population (control)

# Set up, data input and pre-process

## Session info

We first check details of the session and system, and for reproducibility, we set the random seed.

```{r session, cache=FALSE}
starttime <- proc.time()
date()
sessionInfo()
set.seed(42)
options(scipen=0)
```

## Load packages and functions

Next we load the packages that we will use.

```{r packages}
library(foreign)
library(ggplot2)
library(Cairo)
library(knitr)
library(lme4)
library(classInt)
library(car)
library(texreg)
#library(xtable)
library(lmtest)
library(pscl)
library(sjstats)
library(sjPlot)
library(arm)
```

```{r functions}

cv.test = function(df) {
  CV = sqrt(chisq.test(df)$statistic /
              (sum(df) * (min(ncol(df),nrow(df)) - 1)))
  return(as.numeric(CV))
}

id.test <- function(x)
{
  # Takes a vector and calculates the index of dispersion
  # Then evaluates its significance for Overdispersion only
  # Returns a list with named numbers
  mu <- mean(x, na.rm=TRUE)
  names(mu) <- "Mean"
  v <- var(x, na.rm=TRUE)
  names(v) <- "Variance"
  n <- length(x)
  df <- n-1
  names(df) <- "df"
  index <- ((df)*v)/mu
  names(index) <- "I"
  pval <- pchisq(index, df, lower.tail=FALSE)
  names(pval) <- "P-value"
  pv95 <- qchisq(.95, df)
  names(pv95) <- "95% Chi-sq"

  return(c(index, pval, df, pv95))
}

icc_3level <- function(model){
  # Takes a three level lmer and provides the ICC
  # for level 2 and level 3
  require(sjstats)

  icc_l2 <- sum(get_re_var(model))/(sum(get_re_var(model)) +
                          get_re_var(model, "sigma_2"))
  names(icc_l2) <- names(icc(model))[1]

  icc_l3 <- get_re_var(model)[2]/(sum(get_re_var(model)) +
                          get_re_var(model, "sigma_2"))
  names(icc_l3) <- names(icc(model))[2]

  return(c(icc_l2, icc_l3))
}

```

## Load data

We first load and arrange the area and victim level data

```{r victim-level}
enve_all <- read.dbf("enve2014cuest_ciega_2014.dbf")
cat_entidades <- read.csv("cat_entidades.csv", head=TRUE)
homicidios <- read.csv("homicidios_values.csv", header=TRUE)
homicidios <- merge(homicidios, cat_entidades, by="CVE_ENT", all.x=TRUE)
scode <- read.csv("secode.csv", head=TRUE)
scode$Code <- scode$Code*10000

# Prepare data for analysis
# Selecting only the relevant variables

enve_test <- data.frame(extortions=as.integer(as.character(enve_all$P26_10)))

enve_test$extortion_victim <- enve_all$P25_10
enve_test$extortions[enve_test$extortion_victim == 2] <- 0
summary(enve_test$extortions)
table(enve_test$extortions)

enve_test$rep_extortion_victim <- factor(enve_test$extortions)
levels(enve_test$rep_extortion_victim) <- c(0, 0,
                    rep(1, length(levels(enve_test$rep_extortion_victim)) - 2))

summary(enve_test$rep_extortion_victim)


enve_test$CVE_UNICA <- as.integer(as.character(enve_all$ID_CONSECU))

enve_test$bribes <- as.integer(as.character(enve_all$P33))
summary(enve_test$bribes)

# 4 bribe cats
enve_test$bribe1 <- enve_all$P29_1
enve_test$bribe2 <- enve_all$P30_1
enve_test$bribe3 <- enve_all$P31_1
enve_test$bribe4 <- enve_all$P32_1

enve_test$bribes[with(enve_test,
                        bribe1 == 2 &
                        bribe2 == 2 &
                        bribe3 == 2 &
                        bribe4 == 2)] <- 0

summary(enve_test$bribes)

enve_test$bribe_victim <- factor(enve_test$bribes)
levels(enve_test$bribe_victim) <- c(0,
                                    rep(1, length(levels(enve_test$bribe_victim)) - 1))
summary(enve_test$bribe_victim)

enve_test$rep_bribe <- factor(enve_test$bribes)
levels(enve_test$rep_bribe) <- c(0, 0, rep(1,
                                           length(levels(enve_test$rep_bribe)) - 2))
summary(enve_test$rep_bribe)

enve_test$bribe_cats <- factor(enve_test$bribes)
levels(enve_test$bribe_cats) <- c(0, 1, 2, rep("3+",
                                            length(levels(enve_test$bribe_cats)) - 3))
summary(enve_test$bribe_cats)

enve_test$CVE_ENT <- as.integer(as.character(enve_all$CVE_ENT))

enve_test$size <- enve_all$ID_ESTRATO
levels(enve_test$size) <- c("Large", "Medium", "Small", "Micro")

enve_test$sector <- enve_all$SECTOR_FIN

# subsector
enve_test$tempsub <- as.integer(as.character(enve_all$P1_1B))
enve_test$subsector <- cut(enve_test$tempsub, scode$Code, right=FALSE)
levels(enve_test$subsector) <- scode$Sector
enve_test$subsector <- droplevels(enve_test$subsector)
enve_test$subsector <- relevel(enve_test$subsector, ref="Retail")
levels(enve_test$subsector)

enve_test$subsector_safe <- enve_test$subsector

enve_test$subsector <- as.character(enve_test$subsector)

enve_test$subsector[enve_test$subsector %in%
                      c("Mining",
                        "Utilities",
                        "Construction",
                        "Manufacturing")] <- "Industry"

enve_test$subsector[enve_test$subsector %in%
                      c("Finance",
                        "Health",
                        "Leisure",
                        "Education")] <- "Services_Low"

enve_test$subsector[enve_test$subsector %in%
                      c("Media",
                        "Maintenance",
                        "Other",
                        "Corporate")] <- "Services_Mid"

enve_test$subsector[enve_test$subsector %in%
                      c("Prof. services",
                        "Real estate")] <- "Services_Hi"

enve_test$subsector <- as.factor(enve_test$subsector)
enve_test$subsector <- relevel(enve_test$subsector, ref="Retail")
levels(enve_test$subsector)
summary(enve_test$subsector)


enve_test$hotrestbar <- enve_test$subsector
hotindx <- which(levels(enve_test$hotrestbar) == "HotelsRestBar")
levels(enve_test$hotrestbar)[-hotindx] <- 0
levels(enve_test$hotrestbar) <- c(0,1)

enve_test$years <- 2013 - as.numeric(as.character(enve_all$P3))
intyears <- classIntervals(enve_test$years, 5, style="quantile")
enve_test$yearsquant <- cut(enve_test$years, intyears$brks, right=TRUE,
                            include.lowest = TRUE)

enve_test <- merge(enve_test, homicidios, by="CVE_ENT", all.x=TRUE)

length(enve_test$extortions[is.na(enve_test$extortions)])
length(enve_test$bribes[is.na(enve_test$bribes)])

## enve_test$extortions[is.na(enve_test$extortions)] <- 0
## enve_test$bribes[is.na(enve_test$bribes)] <- 0


```

Next we load incident-level data:

```{r incident-level}
enve_incidents_all <- read.dbf("enve2014delitos_ciega_2014.dbf")

# Selecting only those relevant for extortion (code 10)

enve_incidents_all$delito <- as.integer(as.character(enve_incidents_all$ID_DELITO))

enve_incidents <- enve_incidents_all[enve_incidents_all$delito == 10,]

# Selecting those relevant for our study

incident_df <- data.frame(CVE_UNICA=as.integer(as.character(enve_incidents$ID_CONSECU)))

incident_df$delito <- enve_incidents$delito

meses <- c("January", "February", "March",
           "April", "May", "June", "July",
           "August", "September", "October",
           "November", "December", "NONE")

incident_df$month <- enve_incidents$M1_1
levels(incident_df$month) <- meses

incident_df$time <- enve_incidents$M1_3
levels(incident_df$time) <- c("Morning", "Afternoon", "Evening", "Night", "DK/DA")

incident_df$n_offenders <- enve_incidents$M1_8
summary(incident_df$n_offenders)
levels(incident_df$n_offenders) <- c(1:3, "4+", "4+", "4+", "DK/DA")
summary(incident_df$n_offenders)


## Data imputation for missing variables?

incident_df$rel_offenders <- enve_incidents$M1_11
levels(incident_df$rel_offenders) <- c("Employee", "Barely known",
                                       "Somewhat known", "Close acquaintance",
                                       "Total stranger", "DK/DA")
incident_df$rel_offenders <- relevel(incident_df$rel_offenders, ref="Total stranger")

incident_df$had_weapon <- enve_incidents$M1_13
levels(incident_df$had_weapon) <- c("Yes", "No", "DK/DA")
incident_df$had_weapon <- relevel(incident_df$had_weapon, ref="No")

incident_df$gun <- enve_incidents$M1_14_1
levels(incident_df$gun) <- c("Yes", "No", "DK/DA")
incident_df$gun <- relevel(incident_df$gun, ref="No")

incident_df$knife <- enve_incidents$M1_14_2
levels(incident_df$knife) <- c("Yes", "No", "DK/DA")
incident_df$knife <- relevel(incident_df$knife, ref="No")

incident_df$blunt <- enve_incidents$M1_14_3
levels(incident_df$blunt) <- c("Yes", "No", "DK/DA")
incident_df$blunt <- relevel(incident_df$blunt, ref="No")

incident_df$other <- enve_incidents$M1_14_4
levels(incident_df$other)
levels(incident_df$other) <- c("Yes", "No")
incident_df$other <- relevel(incident_df$other, ref="No")

incident_df$weapon_type <- NA
incident_df[which(incident_df$other=="Yes"),"weapon_type"] <- "Other"
incident_df$weapon_type[which(incident_df$blunt=="Yes")] <- "Blunt"
incident_df$weapon_type[which(incident_df$knife=="Yes")] <- "Knife"
incident_df$weapon_type[which(incident_df$gun=="Yes")] <- "Gun"
incident_df$weapon_type[which(incident_df$had_weapon=="No")] <- "None"
incident_df$weapon_type[which(incident_df$had_weapon=="DK/DA")] <- "DK/DA"
incident_df$weapon_type <- as.factor(incident_df$weapon_type)
incident_df$weapon_type <- relevel(incident_df$weapon_type, ref="None")

incident_df$violenceI <- as.character(enve_incidents$M1_15)
incident_df$violenceI <- as.factor(incident_df$violenceI)
levels(incident_df$violenceI) <- c("Yes", "No", "DK/DA")
incident_df$violenceI <- relevel(incident_df$violenceI, ref="No")

incident_df$violenceII <- as.character(enve_incidents$M1_16)
incident_df$violenceII <- as.factor(incident_df$violenceII)
levels(incident_df$violenceII) <- c("Yes", "No", "DK/DA")
incident_df$violenceII <- relevel(incident_df$violenceII, ref="No")

incident_df$with_violence <- NA
incident_df$with_violence[which(incident_df$violenceI == "DK/DA" |
                                  incident_df$violenceII == "DK/DA")] <- 9
incident_df$with_violence[which(incident_df$violenceI == "No" |
                                  incident_df$violenceII == "No")] <- 0
incident_df$with_violence[which(incident_df$violenceI == "Yes" |
                                  incident_df$violenceII == "Yes")] <- 1
incident_df$with_violence <- as.factor(incident_df$with_violence)
levels(incident_df$with_violence) <- c("No", "Yes", "DK/DA")

incident_df$mp <- as.factor(as.character(enve_incidents$M1_18))
levels(incident_df$mp) <- c("Yes", "No", "DK/DA")
incident_df$mp <- relevel(incident_df$mp, ref="No")

incident_df$auto <- as.factor(as.character(enve_incidents$M1_26))
levels(incident_df$auto) <- c("Yes", "No", "DK/DA")
incident_df$auto <- relevel(incident_df$auto, ref="No")

incident_df$reported <- NA
incident_df$reported[which(incident_df$mp == "DK/DA" |
                             incident_df$auto == "DK/DA")] <- 9
incident_df$reported[which(incident_df$mp == "No" |
                             incident_df$auto == "No")] <- 0
incident_df$reported[which(incident_df$mp == "Yes" |
                             incident_df$auto == "Yes")] <- 1
incident_df$reported <- as.factor(incident_df$reported)
levels(incident_df$reported) <- c("No", "Yes", "DK/DA")

incident_df$extortion_type <- as.character(enve_incidents$M5_1)
incident_df$extortion_type <- as.factor(incident_df$extortion_type)
levels(incident_df$extortion_type) <- c("Telephone", "Telephone", "Street",
                                        "Premises", "Cobro de piso", "Telephone")
levels(incident_df$extortion_type)
summary(incident_df$extortion_type)

requests <- with(enve_incidents, data.frame(money=M5_2_1, product=M5_2_2,
                                            nothing=M5_2_3, other=M5_2_4))

incident_df$request <- "Nothing"
incident_df$request[which(requests$other==1)] <- "Other"
incident_df$request[which(requests$nothing==1)] <- "Nothing"
incident_df$request[which(requests$product==1)] <- "Product"
incident_df$request[which(requests$money==1)] <- "Money"
incident_df$request <- as.factor(incident_df$request)
incident_df$request <- relevel(incident_df$request, ref="Other")

incident_df$complied <- enve_incidents$M5_3
levels(incident_df$complied) <-  c("Yes", "No", "DK/DA")
incident_df$complied <- relevel(incident_df$complied, ref="No")

incident_df$complied_bin <- enve_incidents$M5_3
levels(incident_df$complied_bin) <-  c("Yes", "No", NA)
incident_df$complied_bin <- relevel(incident_df$complied_bin, ref="No")

incident_df$retaliation <- enve_incidents$M5_4
levels(incident_df$retaliation) <-  c("Yes", "No", "DK/DA")
incident_df$retaliation <- relevel(incident_df$retaliation, ref="No")

```

Next we merge both incident-level and victim-level tables.

```{r incident-victim-merge}
enve_incvic <- merge(incident_df, enve_test, by="CVE_UNICA")

```

# EDA: Incident level

Before progressing to the modeling exercise, we need to explore the distribution of the different variables. See how many missing values are present, as well as exploring possible bivariate relationships, both between the IV and the DV, as well as between the IVs.

```{r summary}
summary(enve_incvic)
```

Using **compliance and of type of extortion** as DVs, we explore the relationship to different variables.

First we start with incident-level variables.

## Months

### Compliance

```{r compliance-v-months}

## basic summary first

t0 <- table(enve_incvic$month)
t0
round(t0/sum(t0)*100, 2)

## first No NA then with NA

## Use complied_bin

t1 <- table(enve_incvic$month, enve_incvic$complied_bin)
t1
kable(t1)

t1/as.integer(margin.table(t1, margin=1))*100
kable(round(t1/as.integer(margin.table(t1, margin=1))*100, 2))

t2 <- table(enve_incvic$month, enve_incvic$complied_bin, useNA = "ifany")
t2
kable(t2)

t2/as.integer(margin.table(t2, margin=1))*100
kable(round(t2/as.integer(margin.table(t2, margin=1))*100, 2))
```

### Extortion type

```{r ext_type-v-months}
t3 <- table(enve_incvic$extortion_type, enve_incvic$month)
t3
kable(t3)

t3/as.integer(margin.table(t3, margin=1))*100
kable(round(t3/as.integer(margin.table(t3, margin=1))*100, 2))
```

## Time of day

### Compliance

```{r compliance-v-time}

## basic summary first

t4 <- table(enve_incvic$time, useNA="ifany")
t4
round(t4/sum(t4)*100, 2)

## first No NA then with NA

## Use complied_bin

t5 <- table(enve_incvic$time, enve_incvic$complied_bin)
t5
kable(t5)

t5/as.integer(margin.table(t5, margin=1))*100
kable(round(t5/as.integer(margin.table(t5, margin=1))*100, 2))

t6 <- table(enve_incvic$time, enve_incvic$complied_bin, useNA = "ifany")
t6
kable(t6)

t6/as.integer(margin.table(t6, margin=1))*100
kable(round(t6/as.integer(margin.table(t6, margin=1))*100, 2))
```

### Extortion type

```{r ext_type-v-time}

t7 <- table(enve_incvic$extortion_type, enve_incvic$time)
t7
kable(t7)

t7/as.integer(margin.table(t7, margin=1))*100
kable(round(t7/as.integer(margin.table(t7, margin=1))*100, 2))
```

## Number of offenders

### Compliance

```{r compliance-v-numoffenders}

## basic summary first

t8 <- table(enve_incvic$n_offenders, useNA="ifany")
t8
round(t8/sum(t8)*100, 2)

## first No NA then with NA

## Use complied_bin

t9 <- table(enve_incvic$n_offenders, enve_incvic$complied_bin)
t9
kable(t9)

t9/as.integer(margin.table(t9, margin=1))*100
kable(round(t9/as.integer(margin.table(t9, margin=1))*100, 2))

t10 <- table(enve_incvic$n_offenders, enve_incvic$complied_bin, useNA = "ifany")
t10
kable(t10)

t10/as.integer(margin.table(t10, margin=1))*100
kable(round(t10/as.integer(margin.table(t10, margin=1))*100, 2))
```

### Extortion type

```{r ext_type-v-numoffenders}

t11 <- table(enve_incvic$extortion_type, enve_incvic$n_offenders)
t11
kable(t11)

t11/as.integer(margin.table(t11, margin=1))*100
kable(round(t11/as.integer(margin.table(t11, margin=1))*100, 2))

t12 <- table(enve_incvic$extortion_type, enve_incvic$n_offenders, useNA="ifany")
t12
kable(t12)

t12/as.integer(margin.table(t12, margin=1))*100
kable(round(t12/as.integer(margin.table(t12, margin=1))*100, 2))
```

## Relationship to offender

## Compliance

```{r compliance-v-relationship}

## basic summary first

t13 <- table(enve_incvic$rel_offenders, useNA="ifany")
t13
round(t13/sum(t13)*100, 2)

## first No NA then with NA

## Use complied_bin

t14 <- table(enve_incvic$rel_offenders, enve_incvic$complied_bin)
t14
kable(t14)

t14/as.integer(margin.table(t14, margin=1))*100
kable(round(t14/as.integer(margin.table(t14, margin=1))*100, 2))

t15 <- table(enve_incvic$rel_offenders, enve_incvic$complied_bin, useNA = "ifany")
t15
kable(t15)

t15/as.integer(margin.table(t15, margin=1))*100
kable(round(t15/as.integer(margin.table(t15, margin=1))*100, 2))
```

### Extortion type

```{r ext_type-v-relationship}

t16 <- table(enve_incvic$extortion_type, enve_incvic$rel_offenders)
t16
kable(t16)

t16/as.integer(margin.table(t16, margin=1))*100
kable(round(t16/as.integer(margin.table(t16, margin=1))*100, 2))

t17 <- table(enve_incvic$extortion_type, enve_incvic$rel_offenders, useNA="ifany")
t17
kable(t17)

t17/as.integer(margin.table(t17, margin=1))*100
kable(round(t17/as.integer(margin.table(t17, margin=1))*100, 2))
```

## Use of weapon

### Compliance

```{r compliance-v-weaponuse}

## basic summary first

t18 <- table(enve_incvic$had_weapon, useNA="ifany")
t18
round(t18/sum(t18)*100, 2)

## first No NA then with NA

## Use complied_bin

t19 <- table(enve_incvic$had_weapon, enve_incvic$complied_bin)
t19
kable(t19)

t19/as.integer(margin.table(t19, margin=1))*100
kable(round(t19/as.integer(margin.table(t19, margin=1))*100, 2))

t20 <- table(enve_incvic$had_weapon, enve_incvic$complied_bin, useNA = "ifany")

kable(t20)

t20/as.integer(margin.table(t20, margin=1))*100
kable(round(t20/as.integer(margin.table(t20, margin=1))*100, 2))
```

### Extortion type

```{r ext_type-v-weaponuse}

t21 <- table(enve_incvic$extortion_type, enve_incvic$had_weapon)
t21
kable(t21)

t21/as.integer(margin.table(t21, margin=1))*100
kable(round(t21/as.integer(margin.table(t21, margin=1))*100, 2))

t22 <- table(enve_incvic$extortion_type, enve_incvic$had_weapon, useNA="ifany")
t22
kable(t22)

t22/as.integer(margin.table(t22, margin=1))*100
kable(round(t22/as.integer(margin.table(t22, margin=1))*100, 2))
```

## Type of weapon

### Compliance

```{r compliance-v-weapontype}

## basic summary first

t23 <- table(enve_incvic$weapon_type, useNA="ifany")
t23
round(t23/sum(t23)*100, 2)

## first No NA then with NA

## Use complied_bin

t24 <- table(enve_incvic$weapon_type, enve_incvic$complied_bin)
t24
kable(t24)

t24/as.integer(margin.table(t24, margin=1))*100
kable(round(t24/as.integer(margin.table(t24, margin=1))*100, 2))

t25 <- table(enve_incvic$weapon_type, enve_incvic$complied_bin, useNA = "ifany")
t25
kable(t25)

t25/as.integer(margin.table(t25, margin=1))*100
kable(round(t25/as.integer(margin.table(t25, margin=1))*100, 2))
```

### Extortion type

```{r ext_type-v-weapontype}

t26 <- table(enve_incvic$extortion_type, enve_incvic$weapon_type)
t26
kable(t26)

t26/as.integer(margin.table(t26, margin=1))*100
kable(round(t26/as.integer(margin.table(t26, margin=1))*100, 2))

t27 <- table(enve_incvic$extortion_type, enve_incvic$weapon_type, useNA="ifany")
t27
kable(t27)

t27/as.integer(margin.table(t27, margin=1))*100
kable(round(t27/as.integer(margin.table(t27, margin=1))*100, 2))
```

## Use of violence

### Compliance

```{r compliance-v-violence}

## basic summary first

t28 <- table(enve_incvic$with_violence, useNA="ifany")
t28
round(t28/sum(t28)*100, 2)

## first No NA then with NA

## Use complied_bin

t29 <- table(enve_incvic$with_violence, enve_incvic$complied_bin)
t29
kable(t29)

t29/as.integer(margin.table(t29, margin=1))*100
kable(round(t29/as.integer(margin.table(t29, margin=1))*100, 2))

t30 <- table(enve_incvic$with_violence, enve_incvic$complied_bin, useNA = "ifany")
t30
kable(t30)

t30/as.integer(margin.table(t30, margin=1))*100
kable(round(t30/as.integer(margin.table(t30, margin=1))*100, 2))
```

### Extortion type

```{r ext_type-v-violence}

t31 <- table(enve_incvic$extortion_type, enve_incvic$with_violence)
t31
kable(t31)

t31/as.integer(margin.table(t31, margin=1))*100
kable(round(t31/as.integer(margin.table(t31, margin=1))*100, 2))

t32 <- table(enve_incvic$extortion_type, enve_incvic$with_violence, useNA="ifany")
t32
kable(t32)

t32/as.integer(margin.table(t32, margin=1))*100
kable(round(t32/as.integer(margin.table(t32, margin=1))*100, 2))
```

## Reported to the authorities

```{r compliance-v-reported}

## basic summary first

t33 <- table(enve_incvic$reported, useNA="ifany")
t33
round(t33/sum(t33)*100, 2)

## first No NA then with NA

## Use complied_bin

t34 <- table(enve_incvic$reported, enve_incvic$complied_bin)
t34
kable(t34)

t34/as.integer(margin.table(t34, margin=1))*100
kable(round(t34/as.integer(margin.table(t34, margin=1))*100, 2))

t35 <- table(enve_incvic$reported, enve_incvic$complied_bin, useNA = "ifany")
t35
kable(t35)

t35/as.integer(margin.table(t35, margin=1))*100
kable(round(t35/as.integer(margin.table(t35, margin=1))*100, 2))
```

### Extortion type

```{r ext_type-v-reported}

t36 <- table(enve_incvic$extortion_type, enve_incvic$reported)
t36
kable(t36)

t36/as.integer(margin.table(t36, margin=1))*100
kable(round(t36/as.integer(margin.table(t36, margin=1))*100, 2))

t37 <- table(enve_incvic$extortion_type, enve_incvic$reported, useNA="ifany")
t37
kable(t37)

t37/as.integer(margin.table(t37, margin=1))*100
kable(round(t37/as.integer(margin.table(t37, margin=1))*100, 2))
```

## Requested items

### Compliance

```{r compliance-v-requested}

## basic summary first

t38 <- table(enve_incvic$request, useNA="ifany")
t38
round(t38/sum(t38)*100, 2)

## first No NA then with NA

## Use complied_bin

t39 <- table(enve_incvic$request, enve_incvic$complied_bin)
t39
kable(t39)

t39/as.integer(margin.table(t39, margin=1))*100
kable(round(t39/as.integer(margin.table(t39, margin=1))*100, 2))

t40 <- table(enve_incvic$request, enve_incvic$complied_bin, useNA = "ifany")
t40
kable(t40)

t40/as.integer(margin.table(t40, margin=1))*100
kable(round(t40/as.integer(margin.table(t40, margin=1))*100, 2))
```

### Extortion type

```{r ext_type-v-requested}

t41 <- table(enve_incvic$extortion_type, enve_incvic$request)
t41
kable(t41)

t41/as.integer(margin.table(t41, margin=1))*100
kable(round(t41/as.integer(margin.table(t41, margin=1))*100, 2))

t42 <- table(enve_incvic$extortion_type, enve_incvic$request, useNA="ifany")
t42
kable(t42)

t42/as.integer(margin.table(t42, margin=1))*100
kable(round(t42/as.integer(margin.table(t42, margin=1))*100, 2))
```

## Retaliation

### Compliance

```{r compliance-v-retaliation}

## basic summary first

t43 <- table(enve_incvic$retaliation, useNA="ifany")
t43
round(t43/sum(t43)*100, 2)

t44 <- table(enve_incvic$retaliation, useNA="no")
t44
round(t44/sum(t44)*100, 2)

## first No NA then with NA

## Use complied_bin

t45 <- table(enve_incvic$retaliation, enve_incvic$complied_bin)
t45
kable(t45)

t45/as.integer(margin.table(t45, margin=1))*100
kable(round(t45/as.integer(margin.table(t45, margin=1))*100, 2))

t46 <- table(enve_incvic$retaliation, enve_incvic$complied_bin, useNA = "ifany")
t46
kable(t46)

t46/as.integer(margin.table(t46, margin=1))*100
kable(round(t46/as.integer(margin.table(t46, margin=1))*100, 2))
```

### Extortion type

```{r ext_type-v-retaliation}

t47 <- table(enve_incvic$extortion_type, enve_incvic$retaliation)
t47
kable(t47)

t47/as.integer(margin.table(t47, margin=1))*100
kable(round(t47/as.integer(margin.table(t47, margin=1))*100, 2))

t48 <- table(enve_incvic$extortion_type, enve_incvic$retaliation, useNA="ifany")
t48
kable(t48)

t48/as.integer(margin.table(t48, margin=1))*100
kable(round(t48/as.integer(margin.table(t48, margin=1))*100, 2))
```

## Univariate and Bivariate analysis of Compliance and Extortion type

Now we run some univariate and bivariate analysis of extortion compliance and extortion type.

### Univariate

#### Compliance

```{r univariate-compliance}


t49 <- table(enve_incvic$complied, useNA="ifany")
t49
round(t49/sum(t49)*100, 2)

t50 <- table(enve_incvic$complied, useNA="no")
t50
round(t50/sum(t50)*100, 2)

t51 <- table(enve_incvic$complied_bin, useNA="ifany")
t51
round(t51/sum(t51)*100, 2)

t52 <- table(enve_incvic$complied_bin, useNA="no")
t52
round(t52/sum(t52)*100, 2)
```

#### Extortion Type

```{r univariate-ext_type}


t53 <- table(enve_incvic$extortion_type, useNA="ifany")
t53
round(t53/sum(t53)*100, 2)

t54 <- table(enve_incvic$extortion_type, useNA="no")
t54
round(t54/sum(t54)*100, 2)
```

### Bivariate

#### Compliance vs. Extortion type

```{r complied-v-ext_type}

t55 <- table(enve_incvic$extortion_type, enve_incvic$complied_bin)
t55
kable(t55)

t55/as.integer(margin.table(t55, margin=1))*100
kable(round(t55/as.integer(margin.table(t55, margin=1))*100, 2))

t56 <- table(enve_incvic$extortion_type, enve_incvic$complied_bin, useNA="ifany")
t56
kable(t56)

t56/as.integer(margin.table(t56, margin=1))*100
kable(round(t56/as.integer(margin.table(t56, margin=1))*100, 2))
```

## Complete cases

```{r complete-cases}

### total rows of complete cases and excluding certain variables

a <- "complete cases"

paste(length(which(complete.cases(enve_incvic) == TRUE)), a)

## Subsets

### those for sure excluded

excnames <- quote(c(gun,knife,blunt,other,violenceI,violenceII,mp,auto))

paste(length(which(complete.cases(subset(enve_incvic, select=-eval(excnames))) == TRUE)), a)

### excluding retailiation too

excnames <- quote(c(gun,knife,blunt,other,violenceI,violenceII,mp,auto,retaliation))

paste(length(which(complete.cases(subset(enve_incvic, select=-eval(excnames))) == TRUE)), a)

### excluding offender related variables

excnames <- quote(c(gun,knife,blunt,other,violenceI,violenceII,mp,auto,
                    retaliation,n_offenders,rel_offenders))

paste(length(which(complete.cases(subset(enve_incvic, select=-eval(excnames))) == TRUE)), a)

### excluding weapons

excnames <- quote(c(gun,knife,blunt,other,violenceI,violenceII,mp,auto,
                    retaliation,weapon_type))

paste(length(which(complete.cases(subset(enve_incvic, select=-eval(excnames))) == TRUE)), a)

excnames <- quote(c(gun,knife,blunt,other,violenceI,violenceII,mp,auto,
                    retaliation,weapon_type,had_weapon))

paste(length(which(complete.cases(subset(enve_incvic, select=-eval(excnames))) == TRUE)), a)


### excluding weapons and offender related

excnames <- quote(c(gun,knife,blunt,other,violenceI,violenceII,mp,auto,
                    retaliation,n_offenders,rel_offenders,weapon_type))

paste(length(which(complete.cases(subset(enve_incvic, select=-eval(excnames))) == TRUE)), a)

excnames <- quote(c(gun,knife,blunt,other,violenceI,violenceII,mp,auto,
                    retaliation,n_offenders,rel_offenders,weapon_type,had_weapon))

paste(length(which(complete.cases(subset(enve_incvic, select=-eval(excnames))) == TRUE)), a)


### excluding with violence

excnames <- quote(c(gun,knife,blunt,other,violenceI,violenceII,mp,auto,
                    retaliation,with_violence))

paste(length(which(complete.cases(subset(enve_incvic, select=-eval(excnames))) == TRUE)), a)

### excluding with violence and offender and weapons

excnames <- quote(c(gun,knife,blunt,other,violenceI,violenceII,mp,auto,
                    retaliation,n_offenders,rel_offenders,weapon_type,
                    with_violence,had_weapon))

paste(length(which(complete.cases(subset(enve_incvic, select=-eval(excnames))) == TRUE)), a)
```

## Chi-square tests

Chi-square tests for all the tables calculated

```{r chisq-incident}

for (i in 1:56)
{
  print(paste("t",i,sep=""))
  print(chisq.test(get(paste("t",i,sep=""))))
  print("expected")
  print(chisq.test(get(paste("t",i,sep="")))$expected)
  #print(kable(chisq.test(get(paste("t",i,sep="")))$expected))
  print("simulated p-value")
  print(chisq.test(get(paste("t",i,sep="")),simulate.p.value = TRUE, B = 9999))
  print("Cramer's V'")
  print(cv.test(get(paste("t",i,sep=""))))
}

warnings()
```

# EDA: Business and State level

```{r business-level-eda}

business_level_eda <- (subset(enve_test, CVE_UNICA %in%
    enve_incvic$CVE_UNICA))

# Distribution of extortion victimisations

ext_dist <- data.frame(table(business_level_eda$extortions))

colnames(ext_dist) <- c("Events", "Prevalence")

ext_dist$Events<- as.integer(as.character(ext_dist$Events))

ext_dist$Incidence <- ext_dist$Events * ext_dist$Prevalence

ext_dist$preval_per <- prop.table(ext_dist$Prevalence)*100

ext_dist$victim_per[2:length(ext_dist$Events)] <- prop.table(
                                                   ext_dist[2:length(
                                                    ext_dist$Events),2])*100

ext_dist$incid_per <- prop.table(ext_dist$Incidence)*100

ext_dist

kable(ext_dist)

#Poissonnes tests
n <- length(business_level_eda$extortions)
mean_ext <- mean(business_level_eda$extortions, na.rm = TRUE)
var_ext <- var(business_level_eda$extortions, na.rm = TRUE)

mean_ext
var_ext

var_mean_ratio <- var_ext/mean_ext
var_mean_ratio

index_ext <- id.test(enve_test$extortions)
index_ext

vmr_df <- data.frame(Mean=mean_ext, Variance=var_ext, Ratio=var_mean_ratio,
                     Index=unname(index_ext[1]), Pvalue=unname(index_ext[2]),
                     DF=unname(index_ext[3]))

vmr_df

kable(vmr_df)

# plot of extortions
ggplot(business_level_eda, aes(extortions)) +
    geom_histogram(binwidth = 1) +
    coord_trans(y="sqrt") +
    theme_bw() +
    ylab("Frequency") +
    xlab("Extortions") +
    ggtitle("Extortion counts frequency")

ggplot(business_level_eda, aes(extortions)) +
  geom_density() +
  coord_trans(y="sqrt") +
  theme_bw() +
  ggtitle("Extortion counts density")

ggplot(business_level_eda, aes(extortions)) +
  geom_density(adjust=2) +
  coord_trans(y="sqrt") +
  theme_bw() +
  ggtitle("Extortion counts density")

ggplot(business_level_eda, aes(extortions)) +
  geom_density(adjust=3) +
  coord_trans(y="sqrt") +
  theme_bw() +
  ggtitle("Extortion counts density")

ggplot(business_level_eda, aes(extortions)) +
  geom_histogram(aes(y=..density..), binwidth = 1) + geom_density() +
  coord_trans(y="sqrt") +
  theme_bw() +
  ggtitle("Extortion counts density")

ggplot(business_level_eda, aes(extortions)) +
  geom_histogram(aes(y=..density..), binwidth = 1) + geom_density(adjust=2) +
  coord_trans(y="sqrt") +
  theme_bw() +
  ggtitle("Extortion counts density")

ggplot(business_level_eda, aes(extortions)) +
  geom_histogram(aes(y=..density..), binwidth = 1) + geom_density(adjust=3) +
  coord_trans(y="sqrt") +
  theme_bw() +
  ggtitle("Extortion counts density")


## plot the capped distrbution of extortion

capped_ext_count <- table(enve_incvic$CVE_UNICA)

capped_ext_count_df <- data.frame(capped_ext_count)

names(capped_ext_count_df) <- c("CVE_UNICA", "Extortions")

table(capped_ext_count)

ggplot(capped_ext_count_df, aes(Extortions)) +
  geom_histogram(binwidth = 1) +
  coord_trans(y="sqrt") +
  theme_bw() +
  ylab("Frequency") +
  xlab("Capped extortion counts") +
  ggtitle("Capped extortion counts (> 0) frequency") +
  expand_limits(y=1)

ggplot(capped_ext_count_df, aes(Extortions)) +
  geom_histogram(binwidth = 1) +
  #coord_trans(y="sqrt") +
  theme_bw() +
  ylab("Frequency") +
  ggtitle("Capped extortion counts (> 0) frequency") +
  expand_limits(y=1)

ggplot(business_level_eda[business_level_eda$extortions>0,], aes(extortions)) +
  geom_histogram(binwidth = 1) +
  coord_trans(y="sqrt") +
  theme_bw() +
  ylab("Frequency") +
  xlab("Extortions") +
  ggtitle("Uncapped extortion counts (> 0) frequency") +
  expand_limits(y=1)

ggplot(business_level_eda[business_level_eda$extortions>0,], aes(extortions)) +
  geom_histogram(binwidth = 1) +
  #coord_trans(y="sqrt") +
  theme_bw() +
  ylab("Frequency") +
  xlab("Extortions") +
  ggtitle("Uncapped extortion counts (> 0) frequency") +
  expand_limits(y=1)


# other extortion variables
table(business_level_eda$extortion_victim)

table(business_level_eda$rep_extortion_victim)
```

Now we create a summary table of business and state level variables

```{r summ-table}

### Summary table of business and state level variables

summ_table <- data.frame(variable=0, N=0, prevalence=0, incidence=0, mean=0,
                         sd=0, min=0, max=0)

ind <- 1
for (i in 1:length(business_level_eda))
{
  if (colnames(business_level_eda)[i] %in% c("extortions", "bribes"))
  {
    summ_table[ind,1] <- colnames(business_level_eda)[i]
    summ_table[ind,2] <- length(business_level_eda[,i])
    summ_table[ind,3] <- length(business_level_eda[business_level_eda[,i] != 0,i])
    summ_table[ind,4] <- sum(business_level_eda[,i], na.rm = TRUE)
    summ_table[ind,5] <- mean(business_level_eda[,i], na.rm = TRUE)
    summ_table[ind,6] <- sd(business_level_eda[,i], na.rm = TRUE)
    summ_table[ind,7] <- min(business_level_eda[,i], na.rm = TRUE)
    summ_table[ind,8] <- max(business_level_eda[,i], na.rm = TRUE)
  }

  else if (colnames(business_level_eda)[i] %in%
           c("rep_extortion_victim", "bribe_victim", "rep_bribe"))
  {
    summ_table[ind,1] <- colnames(business_level_eda)[i]
    summ_table[ind,2] <- length(business_level_eda[,i])
    summ_table[ind,3] <- length(business_level_eda[business_level_eda[,i] != 0,i])
    summ_table[ind,5] <- summ_table[ind,3]/summ_table[ind,2]
  }

  else if (colnames(business_level_eda)[i] == "years")
  {
    summ_table[ind,1] <- colnames(business_level_eda)[i]
    summ_table[ind,2] <- length(business_level_eda[,i])
    summ_table[ind,5] <- mean(business_level_eda[,i])
    summ_table[ind,6] <- sd(business_level_eda[,i])
    summ_table[ind,7] <- min(business_level_eda[,i])
    summ_table[ind,8] <- max(business_level_eda[,i])
  }

  else if (colnames(business_level_eda)[i] %in% c("size", "subsector",
                                         "restbar", "yearsquant"))
  {
    for (a in 1:length(levels(business_level_eda[,i])))
    {
      summ_table[ind,1] <- levels(business_level_eda[,i])[a]
      summ_table[ind,2] <- length(business_level_eda[business_level_eda[,i] ==
                                        levels(business_level_eda[,i])[a],i])
      summ_table[ind,5] <- summ_table[ind,2]/length(business_level_eda[,1])
      ind <- ind + 1
    }
  }
  ind <- ind + 1
}


summ_table[length(summ_table[,1])+1,] <- c(
            NA, length(homicidios[,"tasahom"]), NA, NA,
            mean(homicidios[,"tasahom"]), sd(homicidios[,"tasahom"]),
            min(homicidios[,"tasahom"]), max(homicidios[,"tasahom"]))

summ_table[length(summ_table[,1]),1] <- "state murder rt"

# homicido absoluto
summ_table[length(summ_table[,1])+1,] <- c(
            NA, length(homicidios[,"denuncias_homs"]), NA, NA,
            mean(homicidios[,"denuncias_homs"]), sd(homicidios[,"denuncias_homs"]),
            min(homicidios[,"denuncias_homs"]), max(homicidios[,"denuncias_homs"]))

summ_table[length(summ_table[,1]),1] <- "Murders"

#population
summ_table[length(summ_table[,1])+1,] <- c(
            NA, length(homicidios[,"poblacion"]), NA, NA,
            mean(homicidios[,"poblacion"])/1000, sd(homicidios[,"poblacion"])/1000,
            min(homicidios[,"poblacion"])/1000, max(homicidios[,"poblacion"])/1000)

summ_table[length(summ_table[,1]),1] <- "Population (in thousands)"

summ_table <- summ_table[!is.na(summ_table[,1]),]

summ_table[,c(5:8)] <- round(summ_table[,c(5:8)],3)

summ_table <- summ_table[-1,]
summ_table

kable(summ_table, row.names = F)
```

As a precaution, explore the distribution of the dependent variable with the categorical business-level variables (size, subsector, yearsquant). Since if some categories have very few observations, they will probably have to be aggregated or the models might not converge.

```{r dv-vs-business-level-cats}
# size

t100 <- table(enve_incvic$size, enve_incvic$complied_bin)
t100
kable(t100)

t100/as.integer(margin.table(t100, margin=1))*100
kable(round(t100/as.integer(margin.table(t100, margin=1))*100, 2))

chisq.test(t100)
chisq.test(t100)$expected

chisq.test(t100, simulate.p.value=TRUE, B=9999)

print("Cramer's V'")
cv.test(t100)

# USE NA

t101 <- table(enve_incvic$size, enve_incvic$complied_bin, useNA = "ifany")
t101
kable(t101)

t101/as.integer(margin.table(t101, margin=1))*100
kable(round(t101/as.integer(margin.table(t101, margin=1))*100, 2))

chisq.test(t101)
chisq.test(t101)$expected

chisq.test(t101, simulate.p.value=TRUE, B=9999)

print("Cramer's V'")
cv.test(t101)

# subsector

t200 <- table(enve_incvic$subsector, enve_incvic$complied_bin)
t200
kable(t200)

t200/as.integer(margin.table(t200, margin=1))*100
kable(round(t200/as.integer(margin.table(t200, margin=1))*100, 2))

chisq.test(t200)
chisq.test(t200)$expected

chisq.test(t200, simulate.p.value=TRUE, B=9999)

print("Cramer's V'")
cv.test(t200)

# USE NA

t201 <- table(enve_incvic$subsector, enve_incvic$complied_bin, useNA = "ifany")
t201
kable(t201)

t201/as.integer(margin.table(t201, margin=1))*100
kable(round(t201/as.integer(margin.table(t201, margin=1))*100, 2))

chisq.test(t201)
chisq.test(t201)$expected

chisq.test(t201, simulate.p.value=TRUE, B=9999)

print("Cramer's V'")
cv.test(t201)

## hotrestbar

t300 <- table(enve_incvic$hotrestbar, enve_incvic$complied_bin)
t300
kable(t300)

t300/as.integer(margin.table(t300, margin=1))*100
kable(round(t300/as.integer(margin.table(t300, margin=1))*100, 2))

chisq.test(t300)
chisq.test(t300)$expected

chisq.test(t300, simulate.p.value=TRUE, B=9999)

print("Cramer's V'")
cv.test(t300)

# USE NA

t301 <- table(enve_incvic$hotrestbar, enve_incvic$complied_bin, useNA = "ifany")
t301
kable(t301)

t301/as.integer(margin.table(t301, margin=1))*100
kable(round(t301/as.integer(margin.table(t301, margin=1))*100, 2))

chisq.test(t301)
chisq.test(t301)$expected

chisq.test(t301, simulate.p.value=TRUE, B=9999)

print("Cramer's V'")
cv.test(t301)

## years quant

t400 <- table(enve_incvic$yearsquant, enve_incvic$complied_bin)
t400
kable(t400)

t400/as.integer(margin.table(t400, margin=1))*100
kable(round(t400/as.integer(margin.table(t400, margin=1))*100, 2))

chisq.test(t400)
chisq.test(t400)$expected

chisq.test(t400, simulate.p.value=TRUE, B=9999)

print("Cramer's V'")
cv.test(t400)

# USE NA

t401 <- table(enve_incvic$yearsquant, enve_incvic$complied_bin, useNA = "ifany")
t401
kable(t401)

t401/as.integer(margin.table(t401, margin=1))*100
kable(round(t401/as.integer(margin.table(t401, margin=1))*100, 2))

chisq.test(t401)
chisq.test(t401)$expected

chisq.test(t401, simulate.p.value=TRUE, B=9999)

print("Cramer's V'")
cv.test(t401)
```

# Models

First we'll try a single level logistic and see how post-hoc analyses work.

As we have many missing values, will start with a saturated model and drop them sequentially, either by hand or through a function.


First we start with the most restricted not excluding weapons, violence or offender variables.

```{r models-with-all}

excnames <- quote(c(complied_bin,
                      extortion_type,
                      month, time,
                      n_offenders,
                      had_weapon,
                      with_violence,
                      reported,
                      rep_extortion_victim,
                      bribe_victim,
                      size, hotrestbar, yearsquant,
                      loghoms, logpop))


m1df <- enve_incvic[which(complete.cases(subset(enve_incvic,
                                                select=eval(excnames)))),]

## Single level first
m1 <- glm(complied_bin ~
           extortion_type +
           time +
           n_offenders +
           had_weapon +
           with_violence +
           reported +
           rep_extortion_victim +
           bribe_victim +
           size + hotrestbar + yearsquant +
           loghoms + logpop,
         data=m1df,
         family = "binomial")

summary(m1)
pR2(m1)

#print(xtable(m1), type="html")
#htmlreg(m1)
screenreg(m1)

nobs(m1)
confint(m1)

# compare with null
lrtest(m1)
kable(lrtest(m1))

waldtest(m1)
kable(waldtest(m1))

waldtest(m1, test="Chisq")
kable(waldtest(m1, test="Chisq"))

# compare sequentially
anova(m1, test="Rao")
kable(anova(m1, test="Rao"))

anova(m1, test="LRT")
kable(anova(m1, test="LRT"))

# Test for multicollinearity
vif(m1)

# testing month
month_m1 <- glm(complied_bin ~
           extortion_type +
           month + time +
           n_offenders +
           had_weapon +
           with_violence +
           reported +
           rep_extortion_victim +
           bribe_victim +
           size + hotrestbar + yearsquant +
           loghoms + logpop,
         data=m1df,
         family = "binomial")

summary(month_m1)

lrtest(month_m1)
waldtest(month_m1)
waldtest(month_m1, test="Chisq")

anova(m1, month_m1, test="LRT")
anova(m1, month_m1, test="Chisq")

lrtest(m1, month_m1)
waldtest(m1, month_m1)
waldtest(m1, month_m1, test="Chisq")


# another test for multicollinearity, but using an lm instead
lm1 <- lm(as.integer(complied_bin) ~
           extortion_type +
           time +
           n_offenders +
           had_weapon +
           with_violence +
           reported +
           rep_extortion_victim +
           bribe_victim +
           size + hotrestbar + yearsquant +
           loghoms + logpop,
         data=m1df)

summary(lm1)

vif(lm1)

## RMSE for the fitted values

rmses <- data.frame(model=NA)

m1_residuals <- residuals(m1, type="response")

rmses$model[1] <- "m1"
rmses$RMSE <- sqrt(mean(m1_residuals^2))
rmses$NRMSE <- sqrt(mean(m1_residuals^2))/sd(m1_residuals)
rmses$CVRMSE <- sqrt(mean(m1_residuals^2))/(max(m1_residuals)-
                                             min(m1_residuals))

rmses
kable(rmses)

# Plot observed vs fitted
m1_ob_pred <- data.frame(Observed=m1df$complied_bin,
                        Predicted=fitted(m1, type=response))

ggplot(m1_ob_pred, aes(Observed, Predicted)) +
 geom_boxplot() +
 theme_bw() +
 ggtitle("Compliance with extortion demands:\nObserved vs. predicted")

## Stepwise selection of variables

sm1 <- step(m1)

summary(sm1)
#print(xtable(sm1), type="html")
#htmlreg(sm1)
screenreg(sm1)

#htmlreg(list(m1, sm1))
screenreg(list(m1, sm1))

sm1$anova
kable(sm1$anova)

## Using drop1 to test single variable exclusions

drop1(m1, test="LRT")
kable(drop1(m1, test="LRT"))

## Exclude state then business level variables

m1_nostate <- glm(complied_bin ~
                    extortion_type +
                    time +
                    n_offenders +
                    had_weapon +
                    with_violence +
                    reported +
                    rep_extortion_victim +
                    bribe_victim +
                    size + hotrestbar + yearsquant,
                  data=m1df,
                  family = "binomial")

summary(m1_nostate)

lrtest(m1_nostate, m1)
kable(lrtest(m1_nostate, m1))

waldtest(m1_nostate, m1)
kable(waldtest(m1_nostate, m1))

waldtest(m1_nostate, m1, test="Chisq")
kable(waldtest(m1_nostate, m1, test="Chisq"))

m1_nostate_nobus <- glm(complied_bin ~
                    extortion_type +
                    time +
                    n_offenders +
                    had_weapon +
                    with_violence +
                    reported,
                  data=m1df,
                  family = "binomial")

summary(m1_nostate_nobus)

lrtest(m1_nostate_nobus, m1_nostate)
kable(lrtest(m1_nostate_nobus, m1_nostate))

waldtest(m1_nostate_nobus, m1_nostate)
kable(waldtest(m1_nostate_nobus, m1_nostate))

waldtest(m1_nostate_nobus, m1_nostate, test="Chisq")
kable(waldtest(m1_nostate_nobus, m1_nostate, test="Chisq"))

lrtest(m1_nostate_nobus, m1_nostate, m1)
kable(lrtest(m1_nostate_nobus, m1_nostate, m1))

waldtest(m1_nostate_nobus, m1_nostate, m1)
kable(waldtest(m1_nostate_nobus, m1_nostate, m1))

waldtest(m1_nostate_nobus, m1_nostate, m1, test="Chisq")
kable(waldtest(m1_nostate_nobus, m1_nostate, m1, test="Chisq"))

## without the vars with a lot of missing

m1_no_viol_off_wea <- glm(complied_bin ~
                          extortion_type +
                          time +
                          reported,
                        data=m1df,
                        family = "binomial")

summary(m1_no_viol_off_wea)

lrtest(m1_no_viol_off_wea, m1_nostate_nobus)
kable(lrtest(m1_no_viol_off_wea, m1_nostate_nobus))

waldtest(m1_no_viol_off_wea, m1_nostate_nobus)
kable(waldtest(m1_no_viol_off_wea, m1_nostate_nobus))

waldtest(m1_no_viol_off_wea, m1_nostate_nobus, test="Chisq")
kable(waldtest(m1_no_viol_off_wea, m1_nostate_nobus, test="Chisq"))

lrtest(m1_no_viol_off_wea, m1_nostate_nobus, m1_nostate, m1)
kable(lrtest(m1_no_viol_off_wea, m1_nostate_nobus, m1_nostate, m1))

waldtest(m1_no_viol_off_wea, m1_nostate_nobus, m1_nostate, m1)
kable(waldtest(m1_no_viol_off_wea, m1_nostate_nobus, m1_nostate, m1))

waldtest(m1_no_viol_off_wea, m1_nostate_nobus, m1_nostate, m1, test="Chisq")
kable(waldtest(m1_no_viol_off_wea, m1_nostate_nobus, m1_nostate, m1, test="Chisq"))

#htmlreg(list(m1,sm1, m1_nostate, m1_nostate_nobus,m1_no_viol_off_wea))
screenreg(list(m1,sm1, m1_nostate, m1_nostate_nobus,m1_no_viol_off_wea))

m1_null <- glm(complied_bin ~ 1, data=m1df, family="binomial")

# Null model
anova(m1_null, m1, test="Chisq")
kable(anova(m1_null, m1, test="Chisq"))

anova(m1_null, m1, test="LRT")
kable(anova(m1_null, m1, test="LRT"))

lrtest(m1_null, m1)
kable(lrtest(m1_null, m1))
```

## Two level model

Now we try a two-level model

```{r two-level-models-with-all}

m1_l2 <- glmer(complied_bin ~
            extortion_type +
            time +
            n_offenders +
            had_weapon +
            with_violence +
            reported +
            rep_extortion_victim +
            bribe_victim +
            size + hotrestbar + yearsquant +
            loghoms + logpop +
            (1|CVE_UNICA),
          data=m1df,
          family = "binomial")

summary(m1_l2)

### ICC

icc(m1_l2)
print(icc(m1_l2), comp="var")

## Describe data structure

## number of observations per individuals

length(unique(m1df$CVE_UNICA))
table(table(m1df$CVE_UNICA))
min(table(m1df$CVE_UNICA))
max(table(m1df$CVE_UNICA))
mean(table(m1df$CVE_UNICA))
sum(table(m1df$CVE_UNICA))

# number of observations per state
length(unique(m1df$CVE_ENT))
table(m1df$CVE_ENT)
sum(table(m1df$CVE_ENT))
min(table(m1df$CVE_ENT))
max(table(m1df$CVE_ENT))
mean(table(m1df$CVE_ENT))

# number of individuals per state

IperG <- with(m1df, tapply(CVE_UNICA, CVE_ENT,
                           FUN = function(x) length(unique(x))))
sum(IperG)
min(IperG)
max(IperG)
mean(IperG)

## print m1_l2
#htmlreg(m1_l2)
screenreg(m1_l2)

nobs(m1_l2)
confint(m1_l2)

## Two-level Null

m1_l2_null <- glmer(complied_bin ~
                      (1|CVE_UNICA),
                    data=m1df,
                    family = "binomial")

summary(m1_l2_null)

lrtest(m1_l2_null, m1_l2)
kable(lrtest(m1_l2_null, m1_l2))

lrtest(m1_null,m1_l2_null, m1_l2)
kable(lrtest(m1_null,m1_l2_null, m1_l2))

# compare sequentially
anova(m1_l2, m1_l2_null, test="LRT")
kable(anova(m1_l2, m1_l2_null, test="LRT"))

anova(m1_l2, m1_l2_null, m1_null, test="LRT")
kable(anova(m1_l2, m1_l2_null, m1_null, test="LRT"))


### RMSES
m1_l2_residuals <- residuals(m1_l2, type="response")

m1_l2_rmses <- c("m1_l2",
              sqrt(mean(m1_l2_residuals^2)),
              sqrt(mean(m1_l2_residuals^2))/sd(m1_l2_residuals),
              sqrt(mean(m1_l2_residuals^2))/
                          (max(m1_l2_residuals)-min(m1_l2_residuals)))

rmses <- rbind(rmses, m1_l2_rmses)

rmses
kable(rmses)

# Plot observed vs fitted
m1_l2_ob_pred <- data.frame(Observed=m1df$complied_bin,
                         Predicted=fitted(m1_l2, type=response))

ggplot(m1_l2_ob_pred, aes(Observed, Predicted)) +
  geom_boxplot() +
  theme_bw() +
  ggtitle("Compliance with extortion demands:\nObserved vs. predicted")

# FOREST PLOTS?
# customize sjplots
set_theme(theme = "blank",
          geom.label.size = 0,
          axis.textsize.x = .7,
          axis.title.size = .9,
          axis.angle.x=90,
          axis.textsize.y = 0)

# Random intercepts
sjp.glmer(m1_l2, show.values = FALSE, sort.est= TRUE)
# Forest plots
set_theme(theme = "blank",
          geom.label.size = 0,
          axis.textsize.x = .7,
          axis.title.size = .9,
          axis.angle.x=90,
          axis.textsize.y = .7)
sjp.glmer(m1_l2, type="fe", show.values = FALSE)
sjp.glmer(m1_l2, type="fe", show.values = FALSE, sort.est = TRUE)

#htmlreg(list(m1, m1_l2))
screenreg(list(m1, m1_l2))

lrtest(m1, m1_l2)
kable(lrtest(m1, m1_l2))

anova(m1_l2, m1, test="LRT")
kable(anova(m1_l2, m1, test="LRT"))
```

## Three level model

Now we try the three-level configuration

```{r three-level-with-all}

m1_l3 <- glmer(complied_bin ~
            extortion_type +
            time +
            n_offenders +
            had_weapon +
            with_violence +
            reported +
            rep_extortion_victim +
            bribe_victim +
            size + hotrestbar + yearsquant +
            loghoms + logpop +
            (1|CVE_UNICA) +
            (1|CVE_ENT),
          data=m1df,
          family = "binomial")

summary(m1_l3)

### ICC for level 2
sum(get_re_var(m1_l3)) / (sum(get_re_var(m1_l3)) +
                        get_re_var(m1_l3, "sigma_2"))

### ICC for level 3
get_re_var(m1_l3)[2] /( sum(get_re_var(m1_l3)) +
                        get_re_var(m1_l3, "sigma_2"))

print(icc(m1_l3), comp="var")

# Try using the icc_3level function

icc_3level(m1_l3)

## Describe data structure

## number of observations per individuals

length(unique(m1df$CVE_UNICA))
table(table(m1df$CVE_UNICA))
min(table(m1df$CVE_UNICA))
max(table(m1df$CVE_UNICA))
mean(table(m1df$CVE_UNICA))
sum(table(m1df$CVE_UNICA))

# number of observations per state
length(unique(m1df$CVE_ENT))
table(m1df$CVE_ENT)
sum(table(m1df$CVE_ENT))
min(table(m1df$CVE_ENT))
max(table(m1df$CVE_ENT))
mean(table(m1df$CVE_ENT))

# number of individuals per state

IperG <- with(m1df, tapply(CVE_UNICA, CVE_ENT,
                           FUN = function(x) length(unique(x))))
sum(IperG)
min(IperG)
max(IperG)
mean(IperG)

## print m1_l3
#htmlreg(m1_l3)
screenreg(m1_l3)

nobs(m1_l3)
confint(m1_l3)

# droptest
m1_l3_dropped <- drop1(m1_l3, test="Chisq")
kable(m1_l3_dropped)


## Three-level Null

m1_l3_null <- glmer(complied_bin ~
                      (1|CVE_UNICA) +
                      (1|CVE_ENT),
                    data=m1df,
                    family = "binomial")

summary(m1_l3_null)

print(icc(m1_l3_null), comp="var")

icc_3level(m1_l3_null)


lrtest(m1_l3_null, m1_l3)
kable(lrtest(m1_l3_null, m1_l3))

lrtest(m1_null,m1_l2_null,m1_l3_null, m1_l3)
kable(lrtest(m1_null,m1_l2_null,m1_l3_null, m1_l3))

lrtest(m1_null,m1_l2_null,m1_l3_null, m1_l3)
kable(lrtest(m1_null,m1_l2_null,m1_l3_null, m1_l3))

lrtest(m1_null,m1_l2_null,m1_l3_null)
kable(lrtest(m1_null,m1_l2_null,m1_l3_null))

# compare sequentially
anova(m1_l3, m1_l3_null, test="LRT")
kable(anova(m1_l3, m1_l3_null, test="LRT"))

anova(m1_l3, m1_l3_null, m1_null, test="LRT")
kable(anova(m1_l3, m1_l3_null, m1_null, test="LRT"))

anova(m1_l3_null, m1_null, test="LRT")
kable(anova(m1_l3_null, m1_null, test="LRT"))

anova(m1_l3_null, m1_l2_null, m1_null, test="LRT")
kable(anova(m1_l3_null, m1_l2_null, m1_null, test="LRT"))

### RMSES
m1_l3_residuals <- residuals(m1_l3, type="response")

m1_l3_rmses <- c("m1_l3",
              sqrt(mean(m1_l3_residuals^2)),
              sqrt(mean(m1_l3_residuals^2))/sd(m1_l3_residuals),
              sqrt(mean(m1_l3_residuals^2))/
                          (max(m1_l3_residuals)-min(m1_l3_residuals)))

rmses <- rbind(rmses, m1_l3_rmses)

rmses
kable(rmses)

# Plot observed vs fitted
m1_l3_ob_pred <- data.frame(Observed=m1df$complied_bin,
                         Predicted=fitted(m1_l3, type=response))

ggplot(m1_l3_ob_pred, aes(Observed, Predicted)) +
  geom_boxplot() +
  theme_bw() +
  ggtitle("Compliance with extortion demands:\nObserved vs. predicted")

# FOREST PLOTS?
# customize sjplots
set_theme(theme = "blank",
          geom.label.size = 0,
          axis.textsize.x = .7,
          axis.title.size = .9,
          axis.angle.x=90,
          axis.textsize.y = 0)

# Random intercepts
sjp.glmer(m1_l3, show.values = FALSE, sort.est= TRUE)
# Forest plots
set_theme(theme = "blank",
          geom.label.size = 0,
          axis.textsize.x = .7,
          axis.title.size = .9,
          axis.angle.x=90,
          axis.textsize.y = .7)
sjp.glmer(m1_l3, type="fe", show.values = FALSE)
sjp.glmer(m1_l3, type="fe", show.values = FALSE, sort.est = TRUE)

#htmlreg(list(m1, m1_l3))
screenreg(list(m1, m1_l3))

#htmlreg(list(m1, m1_l2, m1_l3))
screenreg(list(m1, m1_l2, m1_l3))

lrtest(m1, m1_l3)
kable(lrtest(m1, m1_l3))

anova(m1_l3, m1, test="LRT")
kable(anova(m1_l3, m1, test="LRT"))

lrtest(m1, m1_l2, m1_l3)
kable(lrtest(m1, m1_l2, m1_l3))

anova(m1_l3, m1_l2, m1, test="LRT")
kable(anova(m1_l3, m1_l2, m1, test="LRT"))

lrtest(m1_l2, m1_l3)
kable(lrtest(m1_l2, m1_l3))

anova(m1_l3, m1_l2, test="LRT")
kable(anova(m1_l3, m1_l2, test="LRT"))

```

Now test excluding all three level vars and all two level vars to test their influence.

```{r exc-two-and-three}

## Exclude state then business level variables

m1_l3_nostate <- glmer(complied_bin ~
                    extortion_type +
                    time +
                    n_offenders +
                    had_weapon +
                    with_violence +
                    reported +
                    rep_extortion_victim +
                    bribe_victim +
                    size + hotrestbar + yearsquant +
                    (1|CVE_UNICA) + (1|CVE_ENT),
                  data=m1df,
                  family = "binomial")

summary(m1_l3_nostate)

lrtest(m1_l3_nostate, m1_l3)
kable(lrtest(m1_l3_nostate, m1_l3))

anova(m1_l3_nostate, m1_l3, test="LRT")
kable(anova(m1_l3_nostate, m1_l3, test="LRT"))

## Only incident level

m1_l3_nostate_nobus <- glmer(complied_bin ~
                  extortion_type +
                    time +
                    n_offenders +
                    had_weapon +
                    with_violence +
                    reported +
                    (1|CVE_UNICA) + (1|CVE_ENT),
                  data=m1df,
                  family = "binomial")

summary(m1_l3_nostate_nobus)

lrtest(m1_l3_nostate_nobus, m1_l3_nostate)
kable(lrtest(m1_l3_nostate_nobus, m1_l3_nostate))

anova(m1_l3_nostate_nobus, m1_l3_nostate, test="LRT")
kable(anova(m1_l3_nostate_nobus, m1_l3_nostate, test="LRT"))

lrtest(m1_l3_nostate_nobus, m1_l3_nostate, m1_l3)
kable(lrtest(m1_l3_nostate_nobus, m1_l3_nostate, m1_l3))

anova(m1_l3_nostate_nobus, m1_l3_nostate, m1_l3, test="LRT")
kable(anova(m1_l3_nostate_nobus, m1_l3_nostate, m1_l3, test="LRT"))

lrtest(m1_l3_null, m1_l3_nostate_nobus, m1_l3_nostate, m1_l3)
kable(lrtest(m1_l3_null, m1_l3_nostate_nobus, m1_l3_nostate, m1_l3))

anova(m1_l3_null, m1_l3_nostate_nobus, m1_l3_nostate, m1_l3, test="LRT")
kable(anova(m1_l3_null, m1_l3_nostate_nobus, m1_l3_nostate,
              m1_l3, test="LRT"))



## without the vars with a lot of missing

m1_l3_no_viol_off_wea <- glmer(complied_bin ~
                          extortion_type +
                          time +
                          reported +
                          (1|CVE_UNICA) + (1|CVE_ENT),
                        data=m1df,
                        family = "binomial")

summary(m1_l3_no_viol_off_wea)

lrtest(m1_l3_no_viol_off_wea, m1_l3_nostate_nobus)
kable(lrtest(m1_l3_no_viol_off_wea, m1_l3_nostate_nobus))

anova(m1_l3_no_viol_off_wea, m1_l3_nostate_nobus, test="LRT")
kable(anova(m1_l3_no_viol_off_wea, m1_l3_nostate_nobus, test="LRT"))

lrtest(m1_l3_no_viol_off_wea, m1_l3_nostate_nobus, m1_l3_nostate, m1_l3)
kable(lrtest(m1_l3_no_viol_off_wea, m1_l3_nostate_nobus,
             m1_l3_nostate, m1_l3))

anova(m1_l3_no_viol_off_wea, m1_l3_nostate_nobus,
         m1_l3_nostate, m1_l3, test="LRT")
kable(anova(m1_l3_no_viol_off_wea, m1_l3_nostate_nobus,
               m1_l3_nostate, m1_l3, test="LRT"))

lrtest(m1_l3_null, m1_l3_no_viol_off_wea, m1_l3_nostate_nobus,
        m1_l3_nostate, m1_l3)
kable(lrtest(m1_l3, m1_l3_no_viol_off_wea, m1_l3_nostate_nobus,
                m1_l3_nostate, m1_l3))

anova(m1_l3_null, m1_l3_no_viol_off_wea, m1_l3_nostate_nobus,
        m1_l3_nostate, m1_l3, test="LRT")
kable(anova(m1_l3_null, m1_l3_no_viol_off_wea, m1_l3_nostate_nobus,
        m1_l3_nostate, m1_l3, test="LRT"))


#htmlreg(list(m1_l3,sm1_l3, m1_l3_nostate, m1_l3_nostate_nobus,
#             m1_l3_no_viol_off_wea, m1_l3_null))

screenreg(list(m1_l3, m1_l3_nostate, m1_l3_nostate_nobus,
               m1_l3_no_viol_off_wea, m1_l3_null))

```


# Models with subsector instead of hotrestbar


```{r models-with-subsector}


## Single level first
n1 <- glm(complied_bin ~
           extortion_type +
           time +
           n_offenders +
           had_weapon +
           with_violence +
           reported +
           rep_extortion_victim +
           bribe_victim +
           size + subsector + yearsquant +
           loghoms + logpop,
         data=m1df,
         family = "binomial")

summary(n1)
pR2(n1)

#print(xtable(n1), type="html")
#htmlreg(n1)
screenreg(n1)

nobs(n1)
confint(n1)

# compare with null
lrtest(n1)
kable(lrtest(n1))

waldtest(n1)
kable(waldtest(n1))

waldtest(n1, test="Chisq")
kable(waldtest(n1, test="Chisq"))

# compare sequentially
anova(n1, test="Rao")
kable(anova(n1, test="Rao"))

anova(n1, test="LRT")
kable(anova(n1, test="LRT"))

# Test for multicollinearity
vif(n1)

# another test for multicollinearity, but using an lm instead
ln1 <- lm(as.integer(complied_bin) ~
           extortion_type +
           time +
           n_offenders +
           had_weapon +
           with_violence +
           reported +
           rep_extortion_victim +
           bribe_victim +
           size + subsector + yearsquant +
           loghoms + logpop,
         data=m1df)

summary(ln1)

vif(ln1)

## RMSE for the fitted values

rmses <- data.frame(model=NA)

n1_residuals <- residuals(n1, type="response")

rmses$model[1] <- "n1"
rmses$RMSE <- sqrt(mean(n1_residuals^2))
rmses$NRMSE <- sqrt(mean(n1_residuals^2))/sd(n1_residuals)
rmses$CVRMSE <- sqrt(mean(n1_residuals^2))/(max(n1_residuals)-
                                             min(n1_residuals))

rmses
kable(rmses)

# Plot observed vs fitted
n1_ob_pred <- data.frame(Observed=n1df$complied_bin,
                        Predicted=fitted(n1, type=response))

ggplot(n1_ob_pred, aes(Observed, Predicted)) +
 geom_boxplot() +
 theme_bw() +
 ggtitle("Compliance with extortion demands:\nObserved vs. predicted")

## Stepwise selection of variables

sn1 <- step(n1)

summary(sn1)
#print(xtable(sn1), type="html")
#htmlreg(sn1)
screenreg(sn1)

#htmlreg(list(n1, sn1))
screenreg(list(n1, sn1))

sn1$anova
kable(sn1$anova)

## Using drop1 to test single variable exclusions

drop1(n1, test="LRT")
kable(drop1(n1, test="LRT"))

## Exclude state then business level variables

n1_nostate <- glm(complied_bin ~
                    extortion_type +
                    time +
                    n_offenders +
                    had_weapon +
                    with_violence +
                    reported +
                    rep_extortion_victim +
                    bribe_victim +
                    size + subsector + yearsquant,
                  data=m1df,
                  family = "binomial")

summary(n1_nostate)

lrtest(n1_nostate, n1)
kable(lrtest(n1_nostate, n1))

waldtest(n1_nostate, n1)
kable(waldtest(n1_nostate, n1))

waldtest(n1_nostate, n1, test="Chisq")
kable(waldtest(n1_nostate, n1, test="Chisq"))

n1_nostate_nobus <- glm(complied_bin ~
                    extortion_type +
                    time +
                    n_offenders +
                    had_weapon +
                    with_violence +
                    reported,
                  data=m1df,
                  family = "binomial")

summary(n1_nostate_nobus)

lrtest(n1_nostate_nobus, n1_nostate)
kable(lrtest(n1_nostate_nobus, n1_nostate))

waldtest(n1_nostate_nobus, n1_nostate)
kable(waldtest(n1_nostate_nobus, n1_nostate))

waldtest(n1_nostate_nobus, n1_nostate, test="Chisq")
kable(waldtest(n1_nostate_nobus, n1_nostate, test="Chisq"))

lrtest(n1_nostate_nobus, n1_nostate, n1)
kable(lrtest(n1_nostate_nobus, n1_nostate, n1))

waldtest(n1_nostate_nobus, n1_nostate, n1)
kable(waldtest(n1_nostate_nobus, n1_nostate, n1))

waldtest(n1_nostate_nobus, n1_nostate, n1, test="Chisq")
kable(waldtest(n1_nostate_nobus, n1_nostate, n1, test="Chisq"))

## without the vars with a lot of missing

n1_no_viol_off_wea <- glm(complied_bin ~
                          extortion_type +
                          time +
                          reported,
                        data=m1df,
                        family = "binomial")

summary(n1_no_viol_off_wea)

lrtest(n1_no_viol_off_wea, n1_nostate_nobus)
kable(lrtest(n1_no_viol_off_wea, n1_nostate_nobus))

waldtest(n1_no_viol_off_wea, n1_nostate_nobus)
kable(waldtest(n1_no_viol_off_wea, n1_nostate_nobus))

waldtest(n1_no_viol_off_wea, n1_nostate_nobus, test="Chisq")
kable(waldtest(n1_no_viol_off_wea, n1_nostate_nobus, test="Chisq"))

lrtest(n1_no_viol_off_wea, n1_nostate_nobus, n1_nostate, n1)
kable(lrtest(n1_no_viol_off_wea, n1_nostate_nobus, n1_nostate, n1))

waldtest(n1_no_viol_off_wea, n1_nostate_nobus, n1_nostate, n1)
kable(waldtest(n1_no_viol_off_wea, n1_nostate_nobus, n1_nostate, n1))

waldtest(n1_no_viol_off_wea, n1_nostate_nobus, n1_nostate, n1, test="Chisq")
kable(waldtest(n1_no_viol_off_wea, n1_nostate_nobus, n1_nostate, n1, test="Chisq"))

#htmlreg(list(n1,sn1, n1_nostate, n1_nostate_nobus,n1_no_viol_off_wea))
screenreg(list(n1,sn1, n1_nostate, n1_nostate_nobus,n1_no_viol_off_wea))

n1_null <- glm(complied_bin ~ 1, data=m1df, family="binomial")

# Null model
anova(n1_null, n1, test="Chisq")
kable(anova(n1_null, n1, test="Chisq"))

anova(n1_null, n1, test="LRT")
kable(anova(n1_null, n1, test="LRT"))

lrtest(n1_null, n1)
kable(lrtest(n1_null, n1))
```

## Two level model

Now we try a two-level model

```{r two-level-models-with-subsector}

n1_l2 <- glmer(complied_bin ~
            extortion_type +
            time +
            n_offenders +
            had_weapon +
            with_violence +
            reported +
            rep_extortion_victim +
            bribe_victim +
            size + subsector + yearsquant +
            loghoms + logpop +
            (1|CVE_UNICA),
          data=m1df,
          family = "binomial")

summary(n1_l2)

### ICC

icc(n1_l2)
print(icc(n1_l2), comp="var")

## Describe data structure

## number of observations per individuals

length(unique(n1df$CVE_UNICA))
table(table(n1df$CVE_UNICA))
min(table(n1df$CVE_UNICA))
max(table(n1df$CVE_UNICA))
mean(table(n1df$CVE_UNICA))
sum(table(n1df$CVE_UNICA))

# number of observations per state
length(unique(n1df$CVE_ENT))
table(n1df$CVE_ENT)
sum(table(n1df$CVE_ENT))
min(table(n1df$CVE_ENT))
max(table(n1df$CVE_ENT))
mean(table(n1df$CVE_ENT))

# number of individuals per state

IperG <- with(n1df, tapply(CVE_UNICA, CVE_ENT,
                           FUN = function(x) length(unique(x))))
sum(IperG)
min(IperG)
max(IperG)
mean(IperG)

## print n1_l2
#htmlreg(n1_l2)
screenreg(n1_l2)

nobs(n1_l2)
confint(n1_l2)

## Two-level Null

n1_l2_null <- glmer(complied_bin ~
                      (1|CVE_UNICA),
                    data=m1df,
                    family = "binomial")

summary(n1_l2_null)

lrtest(n1_l2_null, n1_l2)
kable(lrtest(n1_l2_null, n1_l2))

lrtest(n1_null,n1_l2_null, n1_l2)
kable(lrtest(n1_null,n1_l2_null, n1_l2))

# compare sequentially
anova(n1_l2, n1_l2_null, test="LRT")
kable(anova(n1_l2, n1_l2_null, test="LRT"))

anova(n1_l2, n1_l2_null, n1_null, test="LRT")
kable(anova(n1_l2, n1_l2_null, n1_null, test="LRT"))


### RMSES
n1_l2_residuals <- residuals(n1_l2, type="response")

n1_l2_rmses <- c("n1_l2",
              sqrt(mean(n1_l2_residuals^2)),
              sqrt(mean(n1_l2_residuals^2))/sd(n1_l2_residuals),
              sqrt(mean(n1_l2_residuals^2))/
                          (max(n1_l2_residuals)-min(n1_l2_residuals)))

rmses <- rbind(rmses, n1_l2_rmses)

rmses
kable(rmses)

# Plot observed vs fitted
n1_l2_ob_pred <- data.frame(Observed=n1df$complied_bin,
                         Predicted=fitted(n1_l2, type=response))

ggplot(n1_l2_ob_pred, aes(Observed, Predicted)) +
  geom_boxplot() +
  theme_bw() +
  ggtitle("Compliance with extortion demands:\nObserved vs. predicted")

# FOREST PLOTS?
# customize sjplots
set_theme(theme = "blank",
          geom.label.size = 0,
          axis.textsize.x = .7,
          axis.title.size = .9,
          axis.angle.x=90,
          axis.textsize.y = 0)

# Random intercepts
sjp.glmer(n1_l2, show.values = FALSE, sort.est= TRUE)
# Forest plots
set_theme(theme = "blank",
          geom.label.size = 0,
          axis.textsize.x = .7,
          axis.title.size = .9,
          axis.angle.x=90,
          axis.textsize.y = .7)
sjp.glmer(n1_l2, type="fe", show.values = FALSE)
sjp.glmer(n1_l2, type="fe", show.values = FALSE, sort.est = TRUE)

#htmlreg(list(n1, n1_l2))
screenreg(list(n1, n1_l2))

lrtest(n1, n1_l2)
kable(lrtest(n1, n1_l2))

anova(n1_l2, n1, test="LRT")
kable(anova(n1_l2, n1, test="LRT"))
```

## Three level model

Now we try the three-level configuration

```{r three-level-with-subsector}

n1_l3 <- glmer(complied_bin ~
            extortion_type +
            time +
            n_offenders +
            had_weapon +
            with_violence +
            reported +
            rep_extortion_victim +
            bribe_victim +
            size + subsector + yearsquant +
            loghoms + logpop +
            (1|CVE_UNICA) +
            (1|CVE_ENT),
          data=m1df,
          family = "binomial")

summary(n1_l3)

### ICC for level 2
sum(get_re_var(n1_l3)) / (sum(get_re_var(n1_l3)) +
                        get_re_var(n1_l3, "sigma_2"))

### ICC for level 3
get_re_var(n1_l3)[2] /( sum(get_re_var(n1_l3)) +
                        get_re_var(n1_l3, "sigma_2"))

print(icc(n1_l3), comp="var")

# Try using the icc_3level function

icc_3level(n1_l3)

## Describe data structure

## number of observations per individuals

length(unique(n1df$CVE_UNICA))
table(table(n1df$CVE_UNICA))
min(table(n1df$CVE_UNICA))
max(table(n1df$CVE_UNICA))
mean(table(n1df$CVE_UNICA))
sum(table(n1df$CVE_UNICA))

# number of observations per state
length(unique(n1df$CVE_ENT))
table(n1df$CVE_ENT)
sum(table(n1df$CVE_ENT))
min(table(n1df$CVE_ENT))
max(table(n1df$CVE_ENT))
mean(table(n1df$CVE_ENT))

# number of individuals per state

IperG <- with(n1df, tapply(CVE_UNICA, CVE_ENT,
                           FUN = function(x) length(unique(x))))
sum(IperG)
min(IperG)
max(IperG)
mean(IperG)

## print n1_l3
#htmlreg(n1_l3)
screenreg(n1_l3)

nobs(n1_l3)
confint(n1_l3)

# droptest
n1_l3_dropped <- drop1(n1_l3, test="Chisq")
kable(n1_l3_dropped)


## Three-level Null

n1_l3_null <- glmer(complied_bin ~
                      (1|CVE_UNICA) +
                      (1|CVE_ENT),
                    data=m1df,
                    family = "binomial")

summary(n1_l3_null)

print(icc(n1_l3_null), comp="var")

icc_3level(n1_l3_null)


lrtest(n1_l3_null, n1_l3)
kable(lrtest(n1_l3_null, n1_l3))

lrtest(n1_null,n1_l2_null,n1_l3_null, n1_l3)
kable(lrtest(n1_null,n1_l2_null,n1_l3_null, n1_l3))

lrtest(n1_null,n1_l2_null,n1_l3_null, n1_l3)
kable(lrtest(n1_null,n1_l2_null,n1_l3_null, n1_l3))

lrtest(n1_null,n1_l2_null,n1_l3_null)
kable(lrtest(n1_null,n1_l2_null,n1_l3_null))

# compare sequentially
anova(n1_l3, n1_l3_null, test="LRT")
kable(anova(n1_l3, n1_l3_null, test="LRT"))

anova(n1_l3, n1_l3_null, n1_null, test="LRT")
kable(anova(n1_l3, n1_l3_null, n1_null, test="LRT"))

anova(n1_l3_null, n1_null, test="LRT")
kable(anova(n1_l3_null, n1_null, test="LRT"))

anova(n1_l3_null, n1_l2_null, n1_null, test="LRT")
kable(anova(n1_l3_null, n1_l2_null, n1_null, test="LRT"))

### RMSES
n1_l3_residuals <- residuals(n1_l3, type="response")

n1_l3_rmses <- c("n1_l3",
              sqrt(mean(n1_l3_residuals^2)),
              sqrt(mean(n1_l3_residuals^2))/sd(n1_l3_residuals),
              sqrt(mean(n1_l3_residuals^2))/
                          (max(n1_l3_residuals)-min(n1_l3_residuals)))

rmses <- rbind(rmses, n1_l3_rmses)

rmses
kable(rmses)

# Plot observed vs fitted
n1_l3_ob_pred <- data.frame(Observed=n1df$complied_bin,
                         Predicted=fitted(n1_l3, type=response))

ggplot(n1_l3_ob_pred, aes(Observed, Predicted)) +
  geom_boxplot() +
  theme_bw() +
  ggtitle("Compliance with extortion demands:\nObserved vs. predicted")

# FOREST PLOTS?
# customize sjplots
set_theme(theme = "blank",
          geom.label.size = 0,
          axis.textsize.x = .7,
          axis.title.size = .9,
          axis.angle.x=90,
          axis.textsize.y = 0)

# Random intercepts
sjp.glmer(n1_l3, show.values = FALSE, sort.est= TRUE)
# Forest plots
set_theme(theme = "blank",
          geom.label.size = 0,
          axis.textsize.x = .7,
          axis.title.size = .9,
          axis.angle.x=90,
          axis.textsize.y = .7)
sjp.glmer(n1_l3, type="fe", show.values = FALSE)
sjp.glmer(n1_l3, type="fe", show.values = FALSE, sort.est = TRUE)

#htmlreg(list(n1, n1_l3))
screenreg(list(n1, n1_l3))

#htmlreg(list(n1, n1_l2, n1_l3))
screenreg(list(n1, n1_l2, n1_l3))

lrtest(n1, n1_l3)
kable(lrtest(n1, n1_l3))

anova(n1_l3, n1, test="LRT")
kable(anova(n1_l3, n1, test="LRT"))

lrtest(n1, n1_l2, n1_l3)
kable(lrtest(n1, n1_l2, n1_l3))

anova(n1_l3, n1_l2, n1, test="LRT")
kable(anova(n1_l3, n1_l2, n1, test="LRT"))

lrtest(n1_l2, n1_l3)
kable(lrtest(n1_l2, n1_l3))

anova(n1_l3, n1_l2, test="LRT")
kable(anova(n1_l3, n1_l2, test="LRT"))

```

Now test excluding all three level vars and all two level vars to test their influence.

```{r exc-two-and-three-subsector}

## Exclude state then business level variables

n1_l3_nostate <- glmer(complied_bin ~
                    extortion_type +
                    time +
                    n_offenders +
                    had_weapon +
                    with_violence +
                    reported +
                    rep_extortion_victim +
                    bribe_victim +
                    size + subsector + yearsquant +
                    (1|CVE_UNICA) + (1|CVE_ENT),
                  data=m1df,
                  family = "binomial")

summary(n1_l3_nostate)

lrtest(n1_l3_nostate, n1_l3)
kable(lrtest(n1_l3_nostate, n1_l3))

anova(n1_l3_nostate, n1_l3, test="LRT")
kable(anova(n1_l3_nostate, n1_l3, test="LRT"))

## Only incident level

n1_l3_nostate_nobus <- glmer(complied_bin ~
                  extortion_type +
                    time +
                    n_offenders +
                    had_weapon +
                    with_violence +
                    reported +
                    (1|CVE_UNICA) + (1|CVE_ENT),
                  data=m1df,
                  family = "binomial")

summary(n1_l3_nostate_nobus)

lrtest(n1_l3_nostate_nobus, n1_l3_nostate)
kable(lrtest(n1_l3_nostate_nobus, n1_l3_nostate))

anova(n1_l3_nostate_nobus, n1_l3_nostate, test="LRT")
kable(anova(n1_l3_nostate_nobus, n1_l3_nostate, test="LRT"))

lrtest(n1_l3_nostate_nobus, n1_l3_nostate, n1_l3)
kable(lrtest(n1_l3_nostate_nobus, n1_l3_nostate, n1_l3))

anova(n1_l3_nostate_nobus, n1_l3_nostate, n1_l3, test="LRT")
kable(anova(n1_l3_nostate_nobus, n1_l3_nostate, n1_l3, test="LRT"))

lrtest(n1_l3_null, n1_l3_nostate_nobus, n1_l3_nostate, n1_l3)
kable(lrtest(n1_l3_null, n1_l3_nostate_nobus, n1_l3_nostate, n1_l3))

anova(n1_l3_null, n1_l3_nostate_nobus, n1_l3_nostate, n1_l3, test="LRT")
kable(anova(n1_l3_null, n1_l3_nostate_nobus, n1_l3_nostate,
              n1_l3, test="LRT"))



## without the vars with a lot of missing

n1_l3_no_viol_off_wea <- glmer(complied_bin ~
                          extortion_type +
                          time +
                          reported +
                          (1|CVE_UNICA) + (1|CVE_ENT),
                        data=m1df,
                        family = "binomial")

summary(n1_l3_no_viol_off_wea)

lrtest(n1_l3_no_viol_off_wea, n1_l3_nostate_nobus)
kable(lrtest(n1_l3_no_viol_off_wea, n1_l3_nostate_nobus))

anova(n1_l3_no_viol_off_wea, n1_l3_nostate_nobus, test="LRT")
kable(anova(n1_l3_no_viol_off_wea, n1_l3_nostate_nobus, test="LRT"))

lrtest(n1_l3_no_viol_off_wea, n1_l3_nostate_nobus, n1_l3_nostate, n1_l3)
kable(lrtest(n1_l3_no_viol_off_wea, n1_l3_nostate_nobus,
             n1_l3_nostate, n1_l3))

anova(n1_l3_no_viol_off_wea, n1_l3_nostate_nobus,
         n1_l3_nostate, n1_l3, test="LRT")
kable(anova(n1_l3_no_viol_off_wea, n1_l3_nostate_nobus,
               n1_l3_nostate, n1_l3, test="LRT"))

lrtest(n1_l3_null, n1_l3_no_viol_off_wea, n1_l3_nostate_nobus,
        n1_l3_nostate, n1_l3)
kable(lrtest(n1_l3, n1_l3_no_viol_off_wea, n1_l3_nostate_nobus,
                n1_l3_nostate, n1_l3))

anova(n1_l3_null, n1_l3_no_viol_off_wea, n1_l3_nostate_nobus,
        n1_l3_nostate, n1_l3, test="LRT")
kable(anova(n1_l3_null, n1_l3_no_viol_off_wea, n1_l3_nostate_nobus,
        n1_l3_nostate, n1_l3, test="LRT"))


#htmlreg(list(n1_l3,sn1_l3, n1_l3_nostate, n1_l3_nostate_nobus,
#             n1_l3_no_viol_off_wea, n1_l3_null))

screenreg(list(n1_l3, n1_l3_nostate, n1_l3_nostate_nobus,
               n1_l3_no_viol_off_wea, n1_l3_null))

```


# Benchmark stats

```{r timing, cache=FALSE}
endtime <- proc.time()
time <- endtime - starttime
time

print(paste("the script took", round(time[3]/60,2),
              "minutes to run.", sep=" "))
```
